var cfg	= require('./config');
var log = require('log')(cfg, module);

//var MessagesModel   = require('./db').ArticleModel;
	
function createApi() {
	var api = require('express').Router();
	
	api.param(checkParam);
	api.param('id', /^\d+$/);
	
	/*
	api.get('/articles', function(req, res) {
		return ArticleModel.find(function (err, articles) {
			if (!err) {
				return res.send(articles);
			} else {
				res.statusCode = 500;
				log.error('Internal error(%d): %s',res.statusCode,err.message);
				return res.send({ error: 'Server error' });
			}
		});
	});
	*/
	api.get('/error', function(req, res){
	  helpme;
	});
	
	// accept GET request at /user
	api.get('/:id', function (req, res) {
	  res.send('step1 user ' + req.params.id);
	});
	
	/*
	// accept POST request at /user
	api.post('/', function (req, res) {
	  res.send('Got a POST request at /user');
	});

	// accept PUT request at /user
	api.put('/', function (req, res) {
	  res.send('Got a PUT request at /user');
	});

	// accept DELETE request at /user
	api.delete(':id', function (req, res) {
	  res.send('Got a DELETE request at /user');
	});
*/	
	// accept ERROR request at /user
	api.get('/', function(req, res){
	  throw new Error('{"cod":400, "msg":"empty id"}');
	});
	
	
	return api;
}

function checkParam(name, fn){
	if (fn instanceof RegExp) {
		return function(req, res, next, val){
		  var captures;
		  if (captures = fn.exec(String(val))) {
			req.params[name] = captures;
			next();
		  } else {
			next(new Error('{"cod":400, "msg":"Bad '+name+' params"}'));
			//next('route');
		  }
		}
	}
}

exports = module.exports = createApi();