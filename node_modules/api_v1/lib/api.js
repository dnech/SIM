var cfg	= require('./config');
var log = require('log')(cfg, module);

function createApi() {
	var api = require('express').Router();
	
	// LOG all request
	api.all('*', function (req, res, next) {
		log.info("REQUEST %d %s %s", process.domain.id, req.method, req.url);
		next();
	});
	
	api.get('/error', function(req, res){
	  helpme;
	});
	
	// accept GET request at /messages
	api.use('/messages', require('./api_messages'));

	// call ERROR request at /
	api.all('*', function(req, res){
	  throw new Error(JSON.stringify({cod:400, msg:'Unknow request '+req.method+' '+req.url}));
	});
	
	// ERROR function
	api.use(function(err, req, res, next){
		var cod;
		var message;
		try {
			var data = JSON.parse(err.message);
			cod 	 = data.cod;
			message  = data.msg;
			log.info("ERROR "+process.domain.id+" ["+cod+"] "+message);
		} catch(e) {
			cod		 = 500;
			message  = 'Unknow error';
			log.error("ERROR "+process.domain.id+" ["+cod+"] Unknow "+err.stack);
		}
		res.status(cod).send(message);
	});
	
	return api;
}

exports = module.exports = createApi();